!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.simpleDbScheme=e()}(this,function(){"use strict";return function(t,e){e.links&&e.links.forEach((t,n)=>{t.forEach(t=>{const{t:a,c:o}=t;e.tables[a].columns[o].links||(e.tables[a].columns[o].links=[]),e.tables[a].columns[o].links.push(n)})}),Object.keys(e.tables).forEach(t=>{const n=e.tables[t];Object.keys(n.columns).forEach(e=>{const a=n.columns[e];a.name=e,a.tname=t}),n.attr||(n.attr={}),n.attr.name||(n.attr.name=t),n.attr.x||(n.attr.x=0),n.attr.y||(n.attr.y=0)});const n="black",a=2,o=d3.select(t).append("svg").call(d3.zoom().on("zoom",()=>{o.attr("transform",d3.event.transform)})).append("g");function r(t,n,a){t.links&&(a||(a=new WeakSet).add(t),t.links.forEach(t=>{d3.select(`.link-${t}`).attr("stroke",n.strokeColor).attr("stroke-width",n.strokeWidth),e.links[t].forEach(t=>{const{t:o,c:s}=t,c=e.tables[o].columns[s];a.has(c)||(a.add(c),d3.select(`table[data-table=${c.tname}] tr[data-col=${c.name}]`).style("background-color",n.rowColor),r(c,n,a))})}))}Object.values(e.tables).map(t=>(function(t){const e=o.data([t.attr]).append("foreignObject").attr("x",t.attr.x).attr("y",t.attr.y).append("xhtml:div").append("table").attr("data-table",t.attr.name),n=e.append("thead").append("tr").classed("info-ico",!!t.comment).attr("title",t.comment);n.append("th"),n.append("th").text(t.attr.name),n.append("th");const a=e.append("tbody").selectAll("tr").data(Object.values(t.columns)).enter().append("tr").classed("info-comment",t=>!!t.comment).attr("title",t=>t.comment).attr("data-col",t=>t.name);return a.append("td").text(t=>t.id),a.append("td").text(t=>t.name),a.append("td").append("span").attr("class","info-type").text(t=>t.type),e})(t)),d3.drag().on("drag",function(t){const{x:n,y:a}=d3.event;d3.select(this).attr("x",n).attr("y",a),e.links.forEach((t,e)=>{const n=c(t);o.select(`.link-${e}`).attr("d",s(n))}),t.x=n,t.y=a})(d3.selectAll("foreignObject")),d3.selectAll("tbody > tr").on("mouseover",function(t){d3.select(this).style("background-color","red"),t.links&&r(t,{rowColor:"pink",strokeColor:"red",strokeWidth:4})}).on("mouseout",function(t){d3.select(this).style("background-color",null),t.links&&r(t,{rowColor:null,strokeColor:n,strokeWidth:a})});const s=d3.line().x(t=>t.x).y(t=>t.y).curve(d3.curveStepAfter);function c(t){const e=t[0].t,n=t[0].c,a=t[1].t,r=t[1].c,s=d3.selectAll("tbody>tr").filter(t=>t.name===n&&t.tname===e||t.name===r&&t.tname===a).nodes().map(t=>{const e=t.getBoundingClientRect(),n=o.node().getScreenCTM().inverse(),a=d3.select("svg").node().createSVGPoint();a.x=e.x,a.y=e.y+Math.round(e.height/2);const r=a.matrixTransform(n);a.x=e.x+e.width,a.y=e.y+Math.round(e.height/2);const s=a.matrixTransform(n);return[{x:s.x,y:s.y,dir:1},{x:r.x,y:r.y,dir:-1}]});let c,l,d=1/0;return s[0].forEach(t=>{s[1].forEach(e=>{const n=Math.sqrt((t.x+30*t.dir-(e.x+30*e.dir))**2+(t.y-e.y)**2);n<d&&(d=n,c=t,l=e)})}),[c,{x:c.x+30*c.dir,y:c.y},{x:l.x+30*l.dir,y:l.y},l]}e.links.forEach((t,e)=>{const r=c(t);o.append("path").attr("class",`link link-${e}`).attr("d",s(r)).attr("stroke",n).attr("stroke-width",a).attr("fill","none")})}});
